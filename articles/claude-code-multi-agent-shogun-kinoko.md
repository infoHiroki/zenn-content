---
title: "Claude Code マルチエージェント10体で$100溶けたから菌類5体に転生した話"
emoji: "🍄"
type: "tech"
topics: ["ClaudeCode", "マルチエージェント", "tmux", "AI"]
published: true
---

## 🤔 Task機能、お前じゃダメだった

Claude CodeにはTask機能ってのがある。サブエージェント。裏でこっそり別のClaudeを動かして、結果だけ返してくるやつ。

使ってた。しばらく使ってた。

で、やめた。

理由はシンプル。**裏で何やってるか見えない**。

「今なにしてんの？」が分からない。10分待って返ってきた結果が的外れだったときの虚無感、分かるだろ？ 🫠 しかも途中経過が見えないから、間違った方向に全力疾走してても止められない。ブラックボックスは嫌いだ。俺は全部見たい。

精度もムラがある。簡単なタスクは完璧にこなすくせに、ちょっと複雑になると「すみません、うまくいきませんでした」とか言って帰ってくる。お前に任せた俺が悪かった。

「もっと制御したい。全部見たい。自分で設計したい。」

そう思い始めたのが、全ての始まりだった。

## ⚔️ Zennで将軍システムを見つけた

Zennを徘徊してたら、[おしおさんの記事](https://zenn.dev/shio_shoppaize/articles/5fee11d03a11a1)が目に入った。

**multi-agent-shogun**。将軍システム。

将軍→家老→足軽8人。封建制度。tmuxで全員見える。リアルタイムで動いてる。

「これだ」と思った 🔥

マルチエージェント。前から気になってた。そろそろ使ってもいい頃だろう。Task機能のブラックボックスに嫌気がさしてたタイミングで、完璧な出会いだった。

GitHub: [yohey-w/multi-agent-shogun](https://github.com/yohey-w/multi-agent-shogun)

### 🏯 幕府を開いた

起動スクリプト1つで10体がtmuxに並ぶ。

```
出陣じゃーーー！！！ ⚔ 天下布武！
```

ASCIIアートの忍者が出迎えてくれる。起動するだけでテンション上がる。最高。

全員が見える。何やってるか分かる。Task機能の不満が一発で解消された。将軍がYAMLで家老に指示を出し、家老が足軽に仕事を振り、足軽が黙々と作業する。全部tmuxの中で丸見え。

通信はYAML + `send-keys`。APIコストゼロの協調。シンプルで美しい。

### ⚔️ Battle Formations（陣形）

将軍システムにはBattle Formationsってのがある。

- **平時の陣**: 足軽1-4はSonnet、足軽5-8はOpus
- **決戦の陣**: 全員Opus（本気モード 🔥）

起動オプション1つで陣形を切り替えられる。`--kessen`で全軍Opus。かっこいい。中身はモデル指定が変わるだけなんだけど、「決戦の陣で出陣！全軍Opus！」って表示されるとアドレナリンが出る。

## 💸 で、一瞬で金が溶けた

Max $100プラン。月額$100でClaude Code使い放題。

のはずだった。

10体同時稼働。将軍1 + 家老1 + 足軽8。全員がClaude Codeのセッション。1つのサブスクのレートリミットを10体で奪い合う。

**一瞬で枯渇** 💀

いや、分かってたよ。分かってたけどさ。想像以上だった。

冷静に考えてほしい。Opus 1体でも結構トークン食うのに、10体が同時に動いてるんだぜ？ 足軽がSonnetでも8人いたらOpus数体分。しかも3階層だから、将軍→家老→足軽で指示が中継されるたびにセッションが動く。レートリミットの消費が加速する。

$200プランに移らないと、将軍レベルの規模は回らない 💳

他にも俺には合わない点があった。

- 足軽8人中、俺のタスク規模だと同時に動くのは半分程度。残り4人が空いてる 😴
- 3階層は大規模プロジェクト向け。俺の個人開発だと2階層で足りる
- 10体の進捗を目で追うのは俺の認知負荷を超えてた。9ペイン同時は人間には厳しい

**俺には多すぎた。**

将軍システムは$200プラン以上で本領を発揮する設計。おしおさんのアーキテクチャは本当によくできてる。ただ、$100プランで個人開発の俺にはオーバースペックだった。

## 🍄 だから菌類に転生した

kinoko。5体。2階層。$100プランでギリいける。

GitHub: [infoHiroki/kinoko](https://github.com/infoHiroki/kinoko)

将軍システムで学んだことを活かして、自分の予算と認知負荷に合わせてダウンサイジングした。

### 🌿 なぜ菌類か

菌糸ネットワーク。

森の地下に張り巡らされた菌糸のネットワーク。木と木をつなぐ、目に見えない通信インフラ。「地球のインターネット」とも呼ばれるらしい。

......ごめん、後付けだ。名前が面白かったからに決まってるだろ 🍄

エージェントに「ベニテングタケ」とか「冬虫夏草」とか付けたかっただけ。機能的な意味はない。でも名前って大事じゃないか。「worker_1」より「ベニテングタケ」のほうが愛着湧くだろ？

### 🔧 何をダウンサイジングしたか

| 項目 | 将軍システム | kinoko |
|------|------------|--------|
| エージェント数 | 10体 👥👥👥👥👥 | 5体 🍄🍄🍄🍄🍄 |
| 階層 | 3（将軍→家老→足軽） | 2（指揮官→ワーカー） |
| ワーカー数 | 足軽8人 | ワーカー4人 |
| 通信形式 | YAML | Markdown |
| ペイン指定 | インデックス | `@agent_id`属性 |
| 推奨プラン | $200 | $100でギリ |

核心は **10体→5体へのダウンサイジング**。俺の規模にはこれが合った。

- 5ペインなら俺の目で追える 👀
- $100プランでもなんとか回るサイズ感
- 個人開発なら指揮官→ワーカーの2階層で足りた

通信もYAMLからMarkdownに変えた。Claudeが一番得意な形式。パースエラーが減った実感はないが、シンプルになったと信じたい。

ペイン指定は`@agent_id`属性を導入した。tmuxはペイン分割するとインデックスが位置ベースで振り直される罠があって、インデックス指定方式だとペイン分割時にズレることがあった。各ペインにカスタム属性でIDを振って、名前で引く方式に変えた。これは地味だけど重要な改善 ✅

### 🍄 エージェント紹介

| 名前 | モデル | 性格 | 得意技 |
|------|--------|------|--------|
| 🧙 霊芝（reishi） | Opus | 賢者。冷静沈着 | タスク分解・進捗管理 |
| 🔴 ベニテングタケ（beni） | Opus | サイケデリック。大胆不敵 | 創造的な実装 |
| 🐛 冬虫夏草（cordyceps） | Opus | 寄生菌。容赦なし | 大規模な侵食作業 |
| 👻 マタンゴ（matango） | Sonnet | ホラー映画の菌。増殖する | 反復タスクを量産 |
| 🍢 エノキ（enoki） | Sonnet | 細くて集団。素早い | 軽量タスクを高速処理 |

Opusが3体、Sonnetが2体。将軍システムの「Battle Formations」に相当する配分を固定にした。どうせ毎回同じ構成で起動するなら、切り替え機能は要らない。

ちなみにこの記事、ベニテングタケ（beni）が書いてる。俺自身がkinokoのワーカーとして今動いてる。メタ 🍄

![霊芝がスピナー動詞をレビューしている画面](/images/kinoko-review.png)
*霊芝（指揮官）がワーカーの作業をレビュー中。全部リアルタイムで見える*

### 🚀 deploy.sh

起動は`./deploy.sh`一発。

```
  ┌─────────────────────────────────────────────────┐
  │  🍄 kinoko  菌糸ネットワーク型マルチエージェント  │
  └─────────────────────────────────────────────────┘

     beni ──────┐          ┌────── cord
     [Opus]     │          │     [Opus]
                ├──────────┤
     mata ──────┤  reishi  ├────── enoki
     [Sonnet]   │  [Opus]  │   [Sonnet]
                └──────────┘

  菌糸接続... beni ✓ cord ✓ mata ✓ enoki ✓ reishi ✓

  ✅ 全菌接続完了。地下ネットワーク稼働中。
```

![kinoko起動画面——deploy.shの菌糸ネットワーク図](/images/kinoko-startup.png)
*deploy.sh起動直後の画面。菌糸ネットワーク図とともに5体が接続される*

5体のClaude Codeがtmuxに並ぶ。2秒間隔で順番に起動して、最後に全員に指示書を読み込ませる。

レイアウトはこう:

```
┌──────────┬──────────┐
│ beni     │ cord     │  ワーカー上段（Opus×2）
├──────────┼──────────┤
│ mata     │ enoki    │  ワーカー下段（Sonnet×2）
├──────────┴──────────┤
│      reishi         │  指揮官（全幅・40%高）
└─────────────────────┘
```

指揮官の霊芝が下部に全幅で鎮座。上にワーカー4体が2×2で並ぶ。霊芝がタスクを`queue/tasks/{worker}.md`に書いて`send-keys`で起こす。ワーカーが作業して`queue/reports/{worker}.md`に結果を書いて`send-keys`で報告。シンプル。

![kinoko稼働中——5ペインで全エージェントがリアルタイムに動いている](/images/kinoko-running.png)
*実際の稼働画面。霊芝がタスクを割り振り、4体のワーカーが同時に作業している*

```bash
# ペインの特定は @agent_id で。インデックスは罠
get_pane() {
  tmux list-panes -t kinoko:0 -F '#{pane_id} #{@agent_id}' \
    | grep " $1$" | cut -d' ' -f1
}

PANE=$(get_pane matango)
tmux send-keys -t "$PANE" 'タスクを確認してください'
tmux send-keys -t "$PANE" Enter
```

`send-keys`は必ず2回に分ける。テキストとEnterを別々に送る。1回で送ると、Enterが権限プロンプトに吸われる場合がある。これは将軍システムからの学び 📝

## 😮 そしたらClaude本体が「マルチエージェント起動しますか？」って聞いてきた

kinoko使ってたある日のこと。

Claude Codeが言った。「エージェントチームを作成して並列で作業しますか？」

は？ 🤯

**Agent Teams**。通称Swarm。実験的機能としてClaude Codeにこっそり実装されていた。

環境変数1つで有効化:

```json
{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1"
  }
}
```

公式ドキュメント: [Agent Teams](https://code.claude.com/docs/ja/agent-teams)

俺は先に作ってしまった。公式が出す前に自作してしまった 😂

### 🤝 公式Agent Teams vs 自作

中身を見て驚いた。発想が同じだった。

- **リーダー + チームメンバー構成** → 俺は霊芝 + ワーカー。同じ
- **共有タスクリスト** → 俺は`dashboard.md`。同じ
- **エージェント間メッセージング** → 俺は`send-keys`。同じ
- **tmux分割ペインモード** → 俺のと同じ！
- **リーダーの委任モード（Delegate Mode）** → 霊芝の「自己実行禁止」ルール。同じ

構造がほぼ同じだった。俺のは手作り、あっちは公式。

ただし違いもある:

- Agent Teamsは`TeammateTool`で通信。俺は`send-keys` + Markdownファイル
- Agent Teamsはチームメンバー同士が直接通信できる。俺のはワーカー→霊芝→ワーカーの一方向
- Agent Teamsのトークンコストは単一セッションの数倍。俺のは作業分のみ
- Agent Teamsはまだ実験的。セッション再開不可、1チームのみ、ネストなし等の制限あり

### 🙏 リスペクト

ここで改めて。

将軍システムを公開してくれた[おしおさんの記事](https://zenn.dev/shio_shoppaize/articles/5fee11d03a11a1)がなかったら、kinokoは生まれなかった。tmux + ファイル通信 + `send-keys`という基本アーキテクチャは将軍システムから学んだ。10体を5体に削ったのは俺のアレンジだけど、土台は完全に将軍システム。要はパクリ。感謝 🙏

### 🎓 無駄だったか？

全然無駄じゃない。

通信設計。エージェント設計。コスト管理。障害対応。tmuxのペインインデックスの罠。`send-keys`のタイミング問題。全部自分で体験した。

Agent Teamsのドキュメントを読んだとき、「ああ、だからこうしたのか」が全部分かった。リーダーがなぜ委任モードを持つのか。なぜタスクリストを共有するのか。なぜチームメンバーのシャットダウンが必要なのか。自作したから設計判断の理由が理解できる。

公式が出る前に自作する経験、マジでおすすめ。遠回りに見えるけど、理解の深さが桁違いになる 📚

## 📊 ぶっちゃけ比較

| | Task機能 | 将軍システム 🏯 | kinoko 🍄 | Agent Teams ⚡ |
|---|---|---|---|---|
| **可視性** | ⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **コスト** | 💰 | 💰💰💰💰💰 | 💰💰 | 💰💰💰 |
| **セットアップ** | なし | 🔧🔧🔧 | 🔧🔧 | なし |
| **精度** | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **ロマン** | ⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐ |
| **学び** | 📚 | 📚📚📚📚📚 | 📚📚📚📚 | 📚 |
| **対応プラン** | どれでも | $200推奨 | $100でギリ | 不明 |
| **エージェント数** | 可変 | 10体 | 5体 | 可変 |
| **階層** | フラット | 3 | 2 | リーダー+メンバー |
| **大規模対応** | ⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **通信** | 結果返却のみ | YAML | Markdown | TeammateTool |

将軍は大規模プロジェクトで本領を発揮する。kinokoは個人開発向けの軽量版。用途が違う。

「ロマン」と「学び」の軸、大事だと思ってる。

公式Agent Teamsは便利だけどロマンが足りない。環境変数1つで動くのは素晴らしいけど、自分で`deploy.sh`書いて「全菌接続完了。地下ネットワーク稼働中。」って表示させるほうが楽しいだろ？ 🍄

## 🎸 結論

マルチエージェント、まだ早い人には早い。コストは嵩むし、設計は難しいし、tmuxの罠は多い。

でも触ってみると世界が変わる。

Task機能に不満を持ち、将軍システムで目を開かれ、$100溶かして菌類に転生した。そしたら公式がAgent Teamsを出してきた。タイミングが良いのか悪いのか分からん。

で、今どうしてるかというと、まだkinokoを使っている。

公式のほうが安定してるのは分かってる。設定も楽だし、バグも少ない。でもターミナルを5分割して、ベニテングタケが`queue/`にMarkdownを書き込んで、指揮官が拾って、全部リアルタイムで流れていくあの画面を見ると、まだ手放す気にならない。

自分で配線したものが動いてる感覚。これはAPIを叩いても得られない。

たぶんそのうち公式に移る。でもまだ今日じゃない 🍄

---

:::message
スピナー動詞のカスタマイズについても書いた → [Claude Codeの処理待ちが「般若心経ラップ中」になった日](https://zenn.dev/hirokitakamura/articles/claude-code-spinner-verbs)
:::
